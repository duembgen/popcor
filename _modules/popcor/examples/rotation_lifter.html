

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>popcor.examples.rotation_lifter &mdash; POPCOR 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <style>
    .github-link {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .github-link img {
      height: 32px;
      width: 32px;
    }
  </style>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo2.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome to POPCOR!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#problem-formulation">Problem Formulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#example-instantiating-and-using-lifter"><strong>Example: instantiating and using lifter</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#sdp-relaxation">SDP Relaxation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#example-solving-the-qcqp-using-rank-relaxation"><strong>Example: solving the QCQP using rank relaxation</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#autotight-method">AutoTight Method</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#example-tightening-the-sdp-relaxation-using-autotight"><strong>Example: tightening the SDP relaxation using AutoTight</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#autotemplate-method">AutoTemplate Method</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#example-tightening-a-different-problem-using-autotemplate"><strong>Example: tightening a different problem using AutoTemplate</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API and modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/algorithms.html">Core Algorithms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/algorithms.html#autotight">AutoTight</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/algorithms.html#popcor.AutoTight"><code class="docutils literal notranslate"><span class="pre">AutoTight</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/algorithms.html#autotemplate">AutoTemplate</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/algorithms.html#popcor.AutoTemplate"><code class="docutils literal notranslate"><span class="pre">AutoTemplate</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/lifters.html">Base Lifters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lifters.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lifters.html#basics">Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lifters.html#statelifter">StateLifter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/lifters.html#popcor.base_lifters.StateLifter"><code class="docutils literal notranslate"><span class="pre">StateLifter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lifters.html#stereolifter">StereoLifter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/lifters.html#popcor.base_lifters.StereoLifter"><code class="docutils literal notranslate"><span class="pre">StereoLifter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lifters.html#robustposelifter">RobustPoseLifter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/lifters.html#popcor.base_lifters.RobustPoseLifter"><code class="docutils literal notranslate"><span class="pre">RobustPoseLifter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lifters.html#rangeonlylifter">RangeOnlyLifter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/lifters.html#popcor.base_lifters.RangeOnlyLifter"><code class="docutils literal notranslate"><span class="pre">RangeOnlyLifter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lifters.html#polylifter">PolyLifter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/lifters.html#popcor.base_lifters.PolyLifter"><code class="docutils literal notranslate"><span class="pre">PolyLifter</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utils.html">Utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#constraints-and-templates">Constraints and templates</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#popcor.utils.constraint.Constraint"><code class="docutils literal notranslate"><span class="pre">Constraint</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#module-popcor.utils.common">Helpers for matrix and vector operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#popcor.utils.common.create_symmetric"><code class="docutils literal notranslate"><span class="pre">create_symmetric()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#popcor.utils.common.diag_indices"><code class="docutils literal notranslate"><span class="pre">diag_indices()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#popcor.utils.common.get_vec"><code class="docutils literal notranslate"><span class="pre">get_vec()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#popcor.utils.common.ravel_multi_index_triu"><code class="docutils literal notranslate"><span class="pre">ravel_multi_index_triu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#popcor.utils.common.unravel_multi_index_triu"><code class="docutils literal notranslate"><span class="pre">unravel_multi_index_triu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#popcor.utils.common.upper_triangular"><code class="docutils literal notranslate"><span class="pre">upper_triangular()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/templates.html">1. Templates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/templates.html#example-for-autotight">1.1. Example for AutoTight</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/templates.html#popcor.examples.ExampleLifter"><code class="docutils literal notranslate"><span class="pre">ExampleLifter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/templates.html#example-for-autotemplate">1.2. Example for AutoTemplate</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/toy.html">2. Toy Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/toy.html#univariate-polynomials">2.1. Univariate Polynomials</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/toy.html#popcor.examples.Poly4Lifter"><code class="docutils literal notranslate"><span class="pre">Poly4Lifter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/toy.html#popcor.examples.Poly6Lifter"><code class="docutils literal notranslate"><span class="pre">Poly6Lifter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/toy.html#other-toy-examples">2.2. Other Toy Examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/toy.html#popcor.examples.Stereo1DLifter"><code class="docutils literal notranslate"><span class="pre">Stereo1DLifter</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/standard.html">3. Standard Estimation Problems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/standard.html#range-only-localization">3.1. Range-Only Localization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/standard.html#popcor.examples.RangeOnlySqLifter"><code class="docutils literal notranslate"><span class="pre">RangeOnlySqLifter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/standard.html#popcor.examples.RangeOnlyNsqLifter"><code class="docutils literal notranslate"><span class="pre">RangeOnlyNsqLifter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/standard.html#stereo-camera-localization">3.2. Stereo-Camera Localization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/standard.html#popcor.examples.Stereo2DLifter"><code class="docutils literal notranslate"><span class="pre">Stereo2DLifter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/standard.html#popcor.examples.Stereo3DLifter"><code class="docutils literal notranslate"><span class="pre">Stereo3DLifter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/standard.html#rotation-averaging">3.3. Rotation Averaging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/standard.html#popcor.examples.RotationLifter"><code class="docutils literal notranslate"><span class="pre">RotationLifter</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/robust.html">4. Robust Estimation Problems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/robust.html#robust-registration-problems">4.1. Robust Registration Problems</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/robust.html#popcor.examples.MonoLifter"><code class="docutils literal notranslate"><span class="pre">MonoLifter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/robust.html#popcor.examples.WahbaLifter"><code class="docutils literal notranslate"><span class="pre">WahbaLifter</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../whatsnew.html">What’s new</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../whatsnew.html#change-log">Change Log</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../whatsnew.html#unreleased-2025-08-22">[Unreleased] – 2025-08-22</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../whatsnew.html#added">Added</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../whatsnew.html#changed">Changed</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../whatsnew.html#fixed">Fixed</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../whatsnew.html#id2">[0.0.2] - 2025-06-04</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../whatsnew.html#id3">Added</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../whatsnew.html#removed">Removed</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../whatsnew.html#f">Fixed</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../whatsnew.html#id6">[0.0.1] - 2025-05-25</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#how-to-contribute-to-popr">How to contribute to POPR</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#general-guidelines">General guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#adding-a-new-lifter-class">Adding a new lifter class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#adding-new-functionalities">Adding new functionalities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#resources">Resources</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../contributing.html#testing">Testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../contributing.html#setting-up-mosek-license-on-server">Setting up mosek license on server</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../contributing.html#testing-github-actions-locally">Testing Github actions locally</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../contributing.html#running-documentation-locally">Running documentation locally</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">POPCOR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <!-- Empty override file which replaces the top nav breadcrumbs -->
<a href="https://github.com/duembgen/popcor">
  <img style="github-link" src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub logo" width="30", height="30">
  Go to GitHub source code
</a>
<br>
<br>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for popcor.examples.rotation_lifter</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A class for solving rotation averaging problems.</span>

<span class="sd">Some notes and conventions:</span>
<span class="sd">- The rotation matrices are called R_i.</span>
<span class="sd">- We consider two different forms of &quot;lifting&quot;:</span>
<span class="sd">    - &quot;no&quot; corresponds to the rank-1 version, where we define x = [1, c_1, ..., c_N] with each c_i = R_i.flatten(&quot;C&quot;), x in (d**2 x N + 1)</span>
<span class="sd">    - &quot;bm&quot; corresponds to the rank-d version, where we define X.T = [R_0.T; R_1.T; ...; R_N.T], X in (d x (N + 1)*d), and R_0 is the world frame.</span>
<span class="sd">- According to above conventions, HOM is either 1 or R_0, the world frame.</span>
<span class="sd">- Relative measurements are defined such that R_j = R_i @ R_ij</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">poly_matrix.poly_matrix</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolyMatrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rotation</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">popcor.base_lifters</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateLifter</span>

<span class="n">METHOD</span> <span class="o">=</span> <span class="s2">&quot;CG&quot;</span>
<span class="n">SOLVER_KWARGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">min_gradient_norm</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">min_step_size</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_orthogonal_constraints</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">hom</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
    <span class="n">A_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="c1"># enforce diagonal == 1 for R&#39;R = I</span>
        <span class="n">Ei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
        <span class="n">Ei</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Ai</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
            <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Ei</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="n">Ai</span><span class="p">[</span><span class="n">hom</span><span class="p">,</span> <span class="n">hom</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">Ai</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint</span>
            <span class="n">A_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span>
            <span class="n">b_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ai</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ei</span>
            <span class="n">A_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span>
            <span class="n">b_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># enforce off-diagonal == 0 for R&#39;R = I</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">Ei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="n">Ei</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Ei</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Ai</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
                <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">Ei</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="n">Ai</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint</span>
                <span class="n">A_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span>
                <span class="n">b_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Ai</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ei</span>
                <span class="n">A_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span>
                <span class="n">b_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A_list</span><span class="p">,</span> <span class="n">b_list</span>


<div class="viewcode-block" id="RotationLifter">
<a class="viewcode-back" href="../../../examples/standard.html#popcor.examples.RotationLifter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RotationLifter</span><span class="p">(</span><span class="n">StateLifter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotation averaging problem.</span>

<span class="sd">    We solve the following optimization problem:</span>

<span class="sd">    .. math::</span>
<span class="sd">        f(\\theta) = \\min_{R_0, R_1, \\ldots, R_N \\in \\mathrm{SO}^d}</span>
<span class="sd">        \\sum_{i,j \\in \\mathcal{E}} || R_i - R_j \\tilde{R}_{ij} ||_F^2</span>
<span class="sd">        + \\sum_{i=\\in\\mathcal{A}} || R_i - \\tilde{R}_i ||_F^2</span>

<span class="sd">    where :math:`\\tilde{R}_{ij}` are the relative measurements, :math:`\\tilde{R}_{i}` are the absolute measurements,</span>
<span class="sd">    and the unknowns are</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\theta = \\begin{bmatrix} R_1 &amp; R_2 &amp; \\ldots &amp; R_N \\end{bmatrix}</span>


<span class="sd">    We can alternatively replace the absolute-measurement terms by</span>

<span class="sd">    .. math::</span>
<span class="sd">        || R_i - R_w \\tilde{R}_{i} ||_F^2</span>

<span class="sd">    where :math:`R_w` is an arbitrary world frame that we can also optimize over, transforming the solutions</span>
<span class="sd">    by :math:`R_w^{-1}R_i` after to move the world frame to the origin. Using this formulation, all</span>
<span class="sd">    measurements are binary factors, which may simplify implementation.</span>

<span class="sd">    We consider two different formulations of the problem:</span>

<span class="sd">    - level &quot;no&quot; corresponds to the rank-1 version:</span>

<span class="sd">    .. math::</span>
<span class="sd">        x = \\begin{bmatrix} 1, \\mathrm{vec}(R_1), \\ldots, \\mathrm{vec}(R_N) \\end{bmatrix}^T</span>

<span class="sd">    - level &quot;bm&quot; corresponds to the rank-d version (bm=Burer-Monteiro).</span>

<span class="sd">    .. math::</span>
<span class="sd">        X = \\begin{bmatrix} R_1^\\top \\\\ \\vdots \\\\ R_N^\\top \\end{bmatrix}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;bm&quot;</span><span class="p">]</span>
    <span class="n">HOM</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span>
    <span class="n">VARIABLE_LIST</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;c_0&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;c_0&quot;</span><span class="p">,</span> <span class="s2">&quot;c_1&quot;</span><span class="p">]]</span>

    <span class="c1"># whether or not to include the determinant constraints in the known constraints.</span>
    <span class="n">ADD_DETERMINANT</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">NOISE</span> <span class="o">=</span> <span class="mf">1e-3</span>

    <span class="c1"># Add any parameters here that describe the problem (e.g. number of landmarks etc.)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="n">param_level</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">n_abs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">n_rot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">n_rel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sparsity</span><span class="o">=</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">n_rel</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">],</span> <span class="s2">&quot;do not support more than 1 relative measurement per pair currently.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span> <span class="o">=</span> <span class="n">n_rot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_abs</span> <span class="o">=</span> <span class="n">n_abs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_rel</span> <span class="o">=</span> <span class="n">n_rel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span> <span class="o">=</span> <span class="n">sparsity</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">param_level</span><span class="o">=</span><span class="n">param_level</span><span class="p">,</span>
            <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">var_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
            <span class="c1"># self.HOM is the scalar homogenization variable</span>
            <span class="n">var_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">var_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span><span class="p">)})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.HOM is the world frame, which is d x d</span>
            <span class="n">var_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">}</span>
            <span class="n">var_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">var_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a random new feasible point.&quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="n">C</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">angle</span>
                <span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">C</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">C</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_subset</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the lifted vector x given theta and parameters.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span>
        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="k">if</span> <span class="n">var_subset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="n">x_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">var_subset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">:</span>
                    <span class="n">x_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;c&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">x_data</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;untreated key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dim_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dim_x</span><span class="p">(</span><span class="n">var_subset</span><span class="o">=</span><span class="n">var_subset</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">dim_x</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;bm&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">var_subset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">:</span>
                    <span class="n">x_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s2">&quot;c&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">x_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;untreated key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown level </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2"> for RotationLifter&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

            <span class="n">C_flat</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">C_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;bm&quot;</span><span class="p">:</span>
            <span class="c1"># Remember that x is composed of R_0.T, R_1.T, ..., R_N.T</span>
            <span class="c1"># We want to return theta in the form [R*_1, R*_2, ..., R*_N]</span>
            <span class="c1"># where each R*_i := R_0.T @ R_i</span>

            <span class="c1"># d x d</span>
            <span class="n">R0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># nd x d: [R_1.T; R_2.T; ...; R_N.T]</span>
            <span class="n">Ri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">])</span>

            <span class="c1"># return d x nd: [R*_1, R*_2, ..., R*_N]</span>
            <span class="n">Ri_world</span> <span class="o">=</span> <span class="n">R0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Ri</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">Ri_world</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown level </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2"> for RotationLifter&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_relative_measurement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        || R_j - R_i @ R_ij ||_F^2</span>

<span class="sd">        measurements: R_ij = R_i.T @ R_j</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">R_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>
        <span class="n">R_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>
        <span class="n">R_gt</span> <span class="o">=</span> <span class="n">R_i</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">R_j</span>

        <span class="c1"># Generate a random small rotation as noise and apply it</span>
        <span class="k">if</span> <span class="n">noise</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">noise_rotvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">noise</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,))</span>
            <span class="n">Rnoise</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">noise_rotvec</span><span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">3</span>
                <span class="k">else</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">noise_rotvec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">R_gt</span> <span class="o">@</span> <span class="n">Rnoise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">R_gt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_absolute_measurement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">n_meas</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        || R_i - R_w @ R_wi ||</span>

<span class="sd">        measurements:</span>
<span class="sd">                        R_wi = R_w.T @ R_i</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">R_gt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_meas</span><span class="p">):</span>
            <span class="c1"># noise model: R_i = R.T @ Rnoise</span>
            <span class="k">if</span> <span class="n">noise</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Generate a random small rotation as noise and apply it</span>
                <span class="n">noise_rotvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">noise</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,))</span>
                <span class="n">Rnoise</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">noise_rotvec</span><span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">3</span>
                    <span class="k">else</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">noise_rotvec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">Ri</span> <span class="o">=</span> <span class="n">R_gt</span> <span class="o">@</span> <span class="n">Rnoise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Ri</span> <span class="o">=</span> <span class="n">R_gt</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ri</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOISE</span>

        <span class="n">y</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_abs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_absolute_measurement</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_abs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_absolute_measurement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># add prior</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span> <span class="o">==</span> <span class="s2">&quot;chain&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">y</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_relative_measurement</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown sparsity </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_poly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOISE</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_y</span><span class="p">(</span><span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Q_from_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_</span><span class="p">,</span> <span class="n">output_poly</span><span class="o">=</span><span class="n">output_poly</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_Q_from_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">output_poly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;param y: list of noisy rotation matrices.&quot;&quot;&quot;</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">y</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c1"># loop over all absolute measurements of this rotation.</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">Rk</span> <span class="ow">in</span> <span class="n">R</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
                        <span class="c1"># treat unary factors</span>
                        <span class="c1"># Rk is measured</span>
                        <span class="c1"># f(R) = sum_k || R  - Rk ||_F^2</span>
                        <span class="c1">#      = sum_k 2tr(I) - 2tr(R&#39;Rk)</span>
                        <span class="n">Q_test</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">()</span>
                        <span class="n">Q_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">Rk</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="c1"># Not adding below to be consistent with &quot;bm&quot; case, where we cannot</span>
                        <span class="c1"># add a constant term to the cost.</span>
                        <span class="c1"># Q_test[self.HOM, self.HOM] += 2 * self.d</span>
                        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span>
                            <span class="n">cost_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Q_test</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span><span class="p">)</span> <span class="o">@</span> <span class="n">x</span>
                            <span class="n">Ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">key</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>
                            <span class="n">cost_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Ri</span> <span class="o">-</span> <span class="n">Rk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
                            <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cost_x</span> <span class="o">-</span> <span class="n">cost_R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>
                        <span class="n">Q</span> <span class="o">+=</span> <span class="n">Q_test</span>

                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;bm&quot;</span><span class="p">:</span>
                        <span class="c1"># in this case, we use self.HOM as a world frame.</span>
                        <span class="c1"># f(R) = sum_i || R - HOM @ Rk ||</span>
                        <span class="c1"># compare with below:</span>
                        <span class="c1"># R corresponds to Rj, HOM corresponds to Ri</span>
                        <span class="n">Q_test</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">()</span>
                        <span class="n">Q_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">Rk</span>
                        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span>
                            <span class="n">cost_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Q_test</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span><span class="p">)</span> <span class="o">@</span> <span class="n">x</span>
                            <span class="p">)</span>
                            <span class="n">Ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">key</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>
                            <span class="n">cost_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Ri</span> <span class="o">-</span> <span class="n">Rk</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
                            <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cost_x</span> <span class="o">-</span> <span class="n">cost_R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>
                        <span class="n">Q</span> <span class="o">+=</span> <span class="n">Q_test</span>
            <span class="c1"># treat binary factors</span>
            <span class="c1"># f(R) = sum_ij || Rj  - Ri @ Rij ||_F^2</span>
            <span class="c1">#      = sum_ij tr((Rj - Ri @ Rij)&#39;(Rj - Ri @ Rij))</span>
            <span class="c1">#      = sum_ij tr(Rj&#39;Rj) - 2 tr(Rj&#39;Ri Rij) + tr(Rij&#39;Ri&#39;RiRij)</span>
            <span class="c1">#      = sum_ij 2tr(I) - 2tr(Rij Rj&#39; Ri)</span>
            <span class="c1">#      = sum_ij 2tr(I)  - 2c_i&#39; (Rij kron I) c_j</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">key</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
                    <span class="n">Q_test</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">()</span>

                    <span class="c1"># Not adding below to be consistent with &quot;bm&quot; case, where we cannot</span>
                    <span class="c1"># add a constant term to the cost.</span>
                    <span class="c1"># Q_test[self.HOM, self.HOM] += 2 * self.d</span>
                    <span class="n">Q_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span>
                        <span class="k">assert</span> <span class="p">(</span>
                            <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span>
                        <span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>
                        <span class="n">Ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>
                        <span class="n">Rj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>
                        <span class="n">c_j</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">c_i</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">Ri</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">),</span> <span class="n">c_i</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">Rj</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">),</span> <span class="n">c_j</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>

                        <span class="n">tr_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">R</span> <span class="o">@</span> <span class="n">Rj</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Ri</span><span class="p">)</span>
                        <span class="n">tr_c</span> <span class="o">=</span> <span class="n">c_i</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">))</span> <span class="o">@</span> <span class="n">c_j</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tr_R</span> <span class="o">-</span> <span class="n">tr_c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>

                        <span class="n">cost_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Q_test</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span><span class="p">)</span> <span class="o">@</span> <span class="n">x</span>
                        <span class="n">cost_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Rj</span> <span class="o">-</span> <span class="n">Ri</span> <span class="o">@</span> <span class="n">R</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
                        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cost_x</span> <span class="o">-</span> <span class="n">cost_R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>
                    <span class="n">Q</span> <span class="o">+=</span> <span class="n">Q_test</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;bm&quot;</span><span class="p">:</span>
                    <span class="n">Q_test</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">()</span>
                    <span class="n">Q_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">R</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span>
                        <span class="n">Ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>
                        <span class="n">Rj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">]</span>

                        <span class="n">cost_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Q_test</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span><span class="p">)</span> <span class="o">@</span> <span class="n">x</span><span class="p">)</span>
                        <span class="n">cost_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Rj</span> <span class="o">-</span> <span class="n">Ri</span> <span class="o">@</span> <span class="n">R</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
                        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cost_x</span> <span class="o">-</span> <span class="n">cost_R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-9</span>
                    <span class="n">Q</span> <span class="o">+=</span> <span class="n">Q_test</span>

        <span class="k">if</span> <span class="n">output_poly</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Q</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Q</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_and_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A_list</span><span class="p">,</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">output_poly</span><span class="p">,</span> <span class="n">b_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">bi</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span>
        <span class="n">Ai_sparse</span> <span class="o">=</span> <span class="n">Ai</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Ai_sparse</span> <span class="o">@</span> <span class="n">x</span><span class="p">))</span> <span class="o">-</span> <span class="n">bi</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="n">err</span>
        <span class="k">if</span> <span class="n">output_poly</span><span class="p">:</span>
            <span class="n">A_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ai_sparse</span><span class="p">)</span>
        <span class="n">b_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_A0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var_subset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_A0</span><span class="p">(</span><span class="n">var_subset</span><span class="o">=</span><span class="n">var_subset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># using self.HOM, None just to make it clear that the second argument is not used.</span>
            <span class="n">A_orth</span><span class="p">,</span> <span class="n">b_orth</span> <span class="o">=</span> <span class="n">get_orthogonal_constraints</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Ai</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">(</span><span class="n">var_subset</span><span class="p">)</span> <span class="k">for</span> <span class="n">Ai</span> <span class="ow">in</span> <span class="n">A_orth</span><span class="p">],</span> <span class="n">b_orth</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_A_known</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_poly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_redundant</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">A_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">b_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">var_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_dict</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span><span class="p">):</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="p">:</span>
                <span class="n">A_orth</span><span class="p">,</span> <span class="n">b_orth</span> <span class="o">=</span> <span class="n">get_orthogonal_constraints</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">A_orth</span><span class="p">,</span> <span class="n">b_orth</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_and_add</span><span class="p">(</span><span class="n">A_list</span><span class="p">,</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">output_poly</span><span class="p">,</span> <span class="n">b_list</span><span class="p">,</span> <span class="n">bi</span><span class="p">)</span>

                <span class="c1"># enforce that determinant is one.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADD_DETERMINANT</span><span class="p">:</span>
                    <span class="c1"># level &quot;no&quot;:</span>
                    <span class="c1"># C = [a b; c d]; ad - bc - 1 = 0</span>
                    <span class="c1">#    a b c d</span>
                    <span class="c1"># a        1</span>
                    <span class="c1"># b     -1</span>
                    <span class="c1"># c   -1</span>
                    <span class="c1"># d 1</span>
                    <span class="c1"># level &quot;bm&quot;</span>
                    <span class="c1"># C = [a b</span>
                    <span class="c1">#      c d]</span>
                    <span class="c1"># C @ C.T</span>
                    <span class="c1"># [a b] [a c]   [a^2 + b^2 a*c + b*d]</span>
                    <span class="c1"># [c d] [b d] = [a*c + b*d c^2 + d^2]</span>
                    <span class="c1"># cannot be implemented...</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;bm&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot add determinant constraint for level bm&quot;</span>
                        <span class="p">)</span>
                    <span class="n">Ai</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="n">Ai</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                    <span class="n">Ai</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_and_add</span><span class="p">(</span><span class="n">A_list</span><span class="p">,</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">output_poly</span><span class="p">,</span> <span class="n">b_list</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADD_DETERMINANT</span><span class="p">:</span>
                    <span class="c1">#      c11  c12  c13                  c21 * c32 - c31 * c22 = c13</span>
                    <span class="c1"># C = [c21, c22, c23]; c1 x c2 = c3:  c31 * c12 - c11 * c12 = c23</span>
                    <span class="c1">#      c31  c32  c33                  c11 * c22 - c21 * c12 = c33</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Warning: consider implementing the determinant constraint for RobustPoseLifter, d=3&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">add_redundant</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;bm&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No known redundant constraints for level bm&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># enforce diagonal == 1 for RR&#39; = I</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">):</span>
                    <span class="n">Ei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>
                    <span class="n">Ei</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">Ai</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">Ai</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">),</span> <span class="n">Ei</span><span class="p">)</span>
                    <span class="n">Ai</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_and_add</span><span class="p">(</span><span class="n">A_list</span><span class="p">,</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">output_poly</span><span class="p">,</span> <span class="n">b_list</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># enforce structure:</span>
                    <span class="c1"># [cos(x) -sin(x)]</span>
                    <span class="c1"># [sin(x) cos(x)]</span>
                    <span class="c1"># =&gt; [c s -s c]</span>
                    <span class="n">Ai</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">Ai</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_and_add</span><span class="p">(</span><span class="n">A_list</span><span class="p">,</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">output_poly</span><span class="p">,</span> <span class="n">b_list</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

                    <span class="n">Ai</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">Ai</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HOM</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_and_add</span><span class="p">(</span><span class="n">A_list</span><span class="p">,</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">output_poly</span><span class="p">,</span> <span class="n">b_list</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

                <span class="c1"># enforce off-diagonal == 0 for RR&#39; = I</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">):</span>
                        <span class="n">Ei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>
                        <span class="n">Ei</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="n">Ei</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">),</span> <span class="n">Ei</span><span class="p">)</span>
                        <span class="n">Ai</span> <span class="o">=</span> <span class="n">PolyMatrix</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">Ai</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_and_add</span><span class="p">(</span><span class="n">A_list</span><span class="p">,</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">output_poly</span><span class="p">,</span> <span class="n">b_list</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;bm&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">A_list</span><span class="p">,</span> <span class="n">b_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">A_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimates</span><span class="o">=</span><span class="p">{}):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">popcor.utils.plotting_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_frame</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;gt&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span><span class="p">):</span>
            <span class="n">plot_frame</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">theta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">r_wc_w</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>  <span class="c1"># type.ignore</span>
            <span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">linestyles</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">([</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">estimates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rot</span><span class="p">):</span>
                <span class="n">plot_frame</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">ls</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">linestyles</span><span class="p">),</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">r_wc_w</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>  <span class="c1"># type.ignore</span>
                <span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;rotation_lifter</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="si">}</span><span class="s2">d_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cert_tools.linalg_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">rank_project</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cert_tools.sdp_solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve_sdp</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">popcor.utils.plotting_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_matrix</span>

    <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
    <span class="c1"># level = &quot;bm&quot;</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># lifter = RotationLifter(</span>
    <span class="c1">#     d=2, n_abs=0, n_rel=1, n_rot=4, sparsity=&quot;chain&quot;, level=level</span>
    <span class="c1"># )</span>
    <span class="n">lifter</span> <span class="o">=</span> <span class="n">RotationLifter</span><span class="p">(</span>
        <span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_abs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_rel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_rot</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">=</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span>
    <span class="p">)</span>

    <span class="c1"># add relative measurements between all subsequent rotations.</span>
    <span class="c1"># lifter.add_relative_measurement(0, 1, noise=1e-3)</span>
    <span class="c1"># add one absolute measurement to fix Gauge freedom</span>
    <span class="c1"># lifter.add_absolute_measurement(0, noise=1e-5)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">simulate_y</span><span class="p">(</span><span class="n">noise</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="n">theta_gt</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">local_solver</span><span class="p">(</span><span class="n">lifter</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">estimates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;init gt&quot;</span><span class="p">:</span> <span class="n">theta_gt</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">theta_init</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">sample_theta</span><span class="p">()</span>
        <span class="n">theta_i</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">local_solver</span><span class="p">(</span><span class="n">theta_init</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">estimates</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;init random </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_i</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimates</span><span class="o">=</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">get_Q_from_y</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">output_poly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">A_known</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">get_A_known</span><span class="p">(</span><span class="n">output_poly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_redundant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">get_A_b_list</span><span class="p">(</span><span class="n">A_known</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)):</span>
        <span class="n">Ai</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plot_matrix</span><span class="p">(</span><span class="n">Ai</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;A</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_matrix</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">X</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">solve_sdp</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">info_rank</span> <span class="o">=</span> <span class="n">rank_project</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">rank</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EVR: </span><span class="si">{</span><span class="n">info_rank</span><span class="p">[</span><span class="s1">&#39;EVR&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">theta_opt</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">get_theta</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta_opt</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">get_theta</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="n">rank</span><span class="p">])</span>

    <span class="n">estimates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;init gt&quot;</span><span class="p">:</span> <span class="n">theta_gt</span><span class="p">,</span> <span class="s2">&quot;SDP&quot;</span><span class="p">:</span> <span class="n">theta_opt</span><span class="p">}</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimates</span><span class="o">=</span><span class="n">estimates</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, POPCOR Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
   
  <a class="github-link" href="https://github.com/duembgen/popr" target="_blank" title="View on GitHub">
    <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub logo">
  </a>


</body>
</html>